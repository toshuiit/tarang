{% extends "base.html" %}

{% block title %}Run Simulation - Tarang{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-rocket"></i> Launch Simulation</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>Simulation Output</h5>
                            </div>
                            <div class="card-body">
                                <div id="output-container" class="simulation-output">
                                    <div id="status-line">Status: <span id="status" class="status-running">Ready to start</span></div>
                                    <div id="output-content">Click "Start Simulation" to begin...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Controls</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button id="start-btn" class="btn btn-success btn-lg" onclick="startSimulation()">
                                        <i class="fas fa-play"></i> Start Simulation
                                    </button>
                                    <button id="stop-btn" class="btn btn-danger" onclick="stopSimulation()" disabled>
                                        <i class="fas fa-stop"></i> Stop Simulation
                                    </button>
                                    <hr>
                                    <a href="{{ url_for('final_config') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Config
                                    </a>
                                    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-home"></i> Home
                                    </a>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Simulation Info</h6>
                                    <small>
                                        <div><strong>Type:</strong> {{ session.get('kind', 'N/A') }}</div>
                                        <div><strong>Dimension:</strong> {{ session.get('dimension', 'N/A') }}D</div>
                                        <div><strong>Grid:</strong> {{ session.get('nx', 'N/A') }}×{{ session.get('ny', 'N/A') }}×{{ session.get('nz', 'N/A') }}</div>
                                        <div><strong>Machine:</strong> {{ session.get('machine', 'N/A') }}</div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize variables properly
let socket;
let currentProcessId = null;

// Initialize socket connection when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    try {
        socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('simulation_output', function(data) {
            if (currentProcessId && data.process_id === currentProcessId) {
                appendOutput(data.output);
            }
        });

        socket.on('simulation_complete', function(data) {
            if (currentProcessId && data.process_id === currentProcessId) {
                updateStatus('completed', 'Simulation completed successfully!');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
        });

        socket.on('simulation_error', function(data) {
            if (currentProcessId && data.process_id === currentProcessId) {
                updateStatus('error', 'Simulation error: ' + data.error);
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
        });
    } catch (error) {
        console.error('Socket initialization error:', error);
    }
});

function startSimulation() {
    try {
        updateStatus('running', 'Starting simulation...');
        document.getElementById('start-btn').disabled = true;
        
        fetch('/start_simulation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentProcessId = data.process_id;
                updateStatus('running', 'Simulation started successfully');
                clearOutput();
                appendOutput('Starting simulation with Process ID: ' + data.process_id);
                appendOutput('='.repeat(50));
                document.getElementById('stop-btn').disabled = false;
            } else {
                updateStatus('error', 'Failed to start simulation: ' + (data.error || 'Unknown error'));
                document.getElementById('start-btn').disabled = false;
            }
        })
        .catch(error => {
            console.error('Start simulation error:', error);
            updateStatus('error', 'Connection error: ' + error.message);
            document.getElementById('start-btn').disabled = false;
        });
    } catch (error) {
        console.error('Start simulation error:', error);
        updateStatus('error', 'Unexpected error: ' + error.message);
        document.getElementById('start-btn').disabled = false;
    }
}

function stopSimulation() {
    if (currentProcessId) {
        fetch('/kill_process/' + currentProcessId, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus('stopped', 'Simulation stopped by user');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            } else {
                updateStatus('error', 'Failed to stop simulation: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Stop simulation error:', error);
            updateStatus('error', 'Connection error while stopping simulation');
        });
    } else {
        updateStatus('error', 'No active simulation to stop');
        document.getElementById('start-btn').disabled = false;
        document.getElementById('stop-btn').disabled = true;
    }
}

function updateStatus(status, message) {
    const statusElement = document.getElementById('status');
    statusElement.className = 'status-' + status;
    statusElement.textContent = message;
}

function clearOutput() {
    document.getElementById('output-content').innerHTML = '';
}

function appendOutput(text) {
    const outputDiv = document.getElementById('output-content');
    outputDiv.innerHTML += text + '\n';
    outputDiv.scrollTop = outputDiv.scrollHeight;
}
</script>
{% endblock %}
